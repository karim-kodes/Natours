extends ../layouts/layout.pug

block append head
    //- script(src="/js/mapbox.js") 
mixin reviewCard(review)
    .review
        .image
            img(src=`/images/Users/${review.user.photo}`, alt=`${review.user.name}`)
        .user-info
            h4= review.user.name 
            p Traveller
        .rating
            p= review.review
            .stars
                each star in [1,2,3,4,5]
                    i(class = `fa-solid fa-star ${review.rating >= star ? 'rate' : ""}`)

mixin quickFactsCard(iconType, icon, label, text)
    .quick-fact 
        .fact-left 
            i(class=`fa-${iconType} fa-${icon}`)
            h4= label 
        span= text

block content
    .tour-detail-container 
        .top-hero
            img(src=`/Images/Tours/${tour.imageCover}`, alt=`${tour.name}`)
            .top-hero-details
                h1.tour-name= tour.name
                .top-hero-icons 
                    .top-hero-icon 
                        i.fa-solid.fa-clock
                        span= `${tour.duration} days`
                    .top-hero-icon 
                        i.fa-solid.fa-location-dot
                        span= tour.startLocation.description
        section.description
            .left-desc 
                .quick-facts    
                    h2.header-2 Quick Facts 
                    .quick-fact-container
                        +quickFactsCard("regular","calendar", "Next Date", `${tour.startDates[0].toDateString()}`)
                        +quickFactsCard("solid","arrow-trend-up", "Difficulty", `${tour.difficulty}`)
                        +quickFactsCard("regular","user", "Participants", `${tour.maxGroupSize} People`)
                        +quickFactsCard("regular","star", "Rating", `${tour.ratingsAverage}/ 5`)

                .your-guides 
                    h2.header-2 Your Guides
                    .your-guides-container
                        each guide in tour.guides
                            .guide 
                                .guide-left 
                                    img(src=`/images/Users/${guide.photo}`, alt=`${guide.name}`)
                                -   if(guide.role === 'lead-guide') 
                                    h4.header-4 Lead Guide
                                -   if(guide.role === 'guide') 
                                    h4.header-4 Tour Guide
                                span= guide.name 
            .right-desc
                h2.header-2= `About The ${tour.name} `
                - const paragraphs = tour.description.split('\n');
                each p in paragraphs 
                    p= p
               
        section.images
            each img, i in tour.images
                img(src=`/images/Tours/${img}`, alt=`${tour.name} photo ${i + 1}`)
        
        section.tour-map 
            #map(data-locations = `${JSON.stringify(tour.locations)}`)

        section.tour-reviews 
            .tour-review-container 
                each review in tour.reviews
                    +reviewCard(review)

        .tour-footer 
            .tour-booking-container 
                .booking-left
                    img(src='/images/Users/user-male-1.jpeg', alt="user-phto")
                    img(src=`/images/Tours/${tour.images[1]}`, alt="Masaai mara photo 2")
                    img(src=`/images/Tours/${tour.images[2]}`, alt="Masaai mara photo 2")
                .booking-center 
                    h2 What are You Waiting For?
                    p= `${tour.duration} days. 1 adventure. Infinite memories. Make it yours today!`
                if user
                    button.btn.btn--green#payNow(data-tour-id=`${tour._id}`) Book Now 
                else
                    a.booking-cta(href="/login") Log in To book Tour
    script.
        document.addEventListener("DOMContentLoaded", () => {
            const payBtn = document.getElementById("payNow");
            if (!payBtn) return;

            payBtn.addEventListener("click", async () => {
                payBtn.textContent = "Processing...";
                payBtn.disabled = true;

                const tourId = payBtn.dataset.tourId;

                try {
                    const res = await fetch(`/api/payments/pay/${tourId}`, {
                        method: "POST"
                    });

                    const result = await res.json();

                    if (result.authorization_url) {
                        window.location.href = result.authorization_url;
                    } else {
                        alert("Payment failed. Try again.");
                        payBtn.textContent = "Book Now";
                        payBtn.disabled = false;
                    }
                } catch (err) {
                    console.error(err);
                    alert("Something went wrong.");
                    payBtn.textContent = "Book Now";
                    payBtn.disabled = false;
                }
            });
        });    
                    
